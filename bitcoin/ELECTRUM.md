# Electrum Wallet Support

This project now supports **Electrum native seeds** in addition to BIP39 seeds.

## Key Discovery

The test mnemonic in `config.py` (MNEMONIC_12) is an **Electrum NATIVE seed**, not a BIP39 seed. This was discovered after extensive testing showed that standard BIP39 derivation paths did not match the addresses generated by Electrum.

## Electrum vs BIP39: Critical Differences

### 1. Seed-to-Master-Key Derivation

**BIP39:**
```python
salt = b"mnemonic" + passphrase
seed = hashlib.pbkdf2_hmac('sha512', mnemonic, salt, 2048)
```

**Electrum:**
```python
salt = b"electrum" + passphrase  # Different salt!
seed = hashlib.pbkdf2_hmac('sha512', mnemonic, salt, 2048)
```

### 2. Derivation Paths

**BIP39/BIP44:**
- Receiving: `m/44'/0'/0'/0/x`
- Change: `m/44'/0'/0'/1/x`

**Electrum Standard:**
- Receiving: `m/0/x`  (simpler!)
- Change: `m/1/x`

### 3. Public Key Format

**BIP39 (default):**
- Uses **uncompressed** public keys (65 bytes, starts with `04`)
- Address generation uses uncompressed format

**Electrum:**
- Uses **compressed** public keys (33 bytes, starts with `02` or `03`)
- Addresses derived from compressed format

### 4. Seed Validation

**BIP39:**
- Uses wordlist-dependent checksum
- Last word contains checksum bits

**Electrum:**
- Uses HMAC-SHA512 with key `"Seed version"`
- Hash must start with version prefix (`01` for standard)

## Usage

### Creating an Electrum Wallet

```python
from bitcoin.wallet import Wallet

# Create from Electrum native seed
wallet = Wallet.from_electrum_seed("grit problem ball awesome...")

# Check wallet type
print(wallet.wallet_type)  # 'electrum'
print(wallet.seed_type)     # 'standard'

# Get addresses (uses compressed pubkeys automatically)
print(wallet.get_address())  # First receiving address (m/0/0)
print(wallet.get_change_address())  # First change address (m/1/0)
```

### Creating a BIP39 Wallet

```python
# For BIP39 seeds, use the existing method
wallet = Wallet.from_mnemonic("witch collapse practice...")

print(wallet.wallet_type)  # 'bip39'
```

## Verified Test Addresses

Using the test mnemonic `MNEMONIC_12`, the following addresses have been verified against Electrum:

- **m/0/0** (receiving): `1DqEczkgKeQNDHCoMFubQebMEoNW3Bx7X5` ✓
- **m/0/1** (receiving): `1FsARj423XtyNuiLRUEzYZQDZsrKrqaNoV` ✓
- **m/1/0** (change): `1EGHUD4NTGWR5n1bL9qroHqbTaMoPZE6a7` ✓

Master key verification:
- **xpub**: `xpub661MyMwAqRbcFWMdzBLTpwv2egaPXhWBAmoStC5rUkEFZ8RyajXySawMCrH12h1obtVY8pdKAdS8mperMLe6KUyppduasmNHibUnM37nq9q` ✓
- **Fingerprint**: `f5934df8` ✓

## Implementation Files

### Core Modules

- **`bitcoin/electrum_utils.py`** - Electrum-specific utility functions
  - `is_electrum_seed()` - Detect Electrum native seeds
  - `electrum_mnemonic_to_seed()` - Electrum PBKDF2 derivation
  - `pubkey_to_address_compressed()` - Address generation with compressed keys
  - `get_electrum_master_xpub()` - Calculate master xpub
  - `get_electrum_root_fingerprint()` - Calculate BIP32 fingerprint
  - `get_compressed_pubkey()` - Convert uncompressed public key to compressed format

- **`bitcoin/wallet.py`** - Updated with Electrum support
  - `from_electrum_seed()` - Create Electrum HD wallet
  - `get_address()` - Auto-detects wallet type, uses compressed keys for Electrum
  - `get_change_address()` - Supports both BIP44 and Electrum paths
  - `get_new_receiving_address()` - Supports both BIP44 and Electrum paths
  - `get_private_key_for_address()` - Fixed to use correct derivation paths for Electrum

- **`bitcoin/transaction.py`** - Transaction creation with Electrum support
  - Auto-detects Electrum wallets and uses compressed public keys
  - Properly generates change addresses for Electrum wallets

- **`bitcoin/txnUtils.py`** - Low-level transaction utilities
  - `makeSignedTransaction()` - Updated to support compressed public keys
  - `verifyTxnSignature()` - Updated to verify both compressed and uncompressed keys
  - `getSignableTxn()` - Updated to reconstruct addresses from compressed keys

### Utility Scripts

- **`bitcoin/verify_master_key.py`** - Verify master key derivation
  - Checks xpub against Electrum
  - Verifies root fingerprint
  - Useful for debugging derivation issues

- **`bitcoin/find_addresses_compressed.py`** - Find addresses in HD wallet
  - Searches using compressed public keys
  - Fast offline search
  - Use this for finding specific addresses

### Demo

- **`bitcoin/hd_wallet_demo.py`** - Complete Electrum wallet demonstration
  - Shows address generation
  - Verifies against real Electrum addresses
  - Demonstrates auto-discovery

## Running the Demo

```bash
cd bitcoin
python hd_wallet_demo.py
```

Expected output:
- ✓ First address matches Electrum
- ✓ Change address matches Electrum
- ✓ Wallet type correctly identified as 'electrum'

## Finding Addresses

To find specific addresses in your wallet:

```bash
cd bitcoin

# Find addresses (searches up to index 2000)
python find_addresses_compressed.py

# Verify master key matches Electrum
python verify_master_key.py

# With passphrase
python verify_master_key.py --passphrase "your passphrase"
```

## Technical Notes

### Why This Matters

Using the wrong derivation method produces **completely different addresses**. If you try to use BIP39 derivation on an Electrum seed (or vice versa), you will NOT find your bitcoins!

### Compressed vs Uncompressed Keys

The same private key generates different addresses depending on public key format:

```
Private key: 8a556dba4a535e7c9324...

Uncompressed pubkey → 1QCiBwsyT7Wb1bJCyK9XXWvibjxfKuSLuD
Compressed pubkey   → 1DqEczkgKeQNDHCoMFubQebMEoNW3Bx7X5
                      ↑ This matches Electrum!
```

### Seed Extension (Passphrase)

Electrum supports an optional "seed extension" (passphrase):
- Different from wallet password (which only encrypts the file)
- Changes the derived addresses completely
- Same as BIP39 passphrase concept, but with `b"electrum"` salt

```python
# Without passphrase
wallet = Wallet.from_electrum_seed(mnemonic, passphrase="")

# With passphrase
wallet = Wallet.from_electrum_seed(mnemonic, passphrase="my secret")
```

## Troubleshooting

### Addresses Don't Match Electrum

1. **Check seed type**:
   ```python
   from bitcoin.electrum_utils import is_electrum_seed
   print(is_electrum_seed(mnemonic))  # Should return 'standard'
   ```

2. **Verify you're using the right method**:
   - Electrum native seed → `Wallet.from_electrum_seed()`
   - BIP39 seed → `Wallet.from_mnemonic()`

3. **Check for seed extension (passphrase)**:
   - Try with and without passphrase
   - Wallet password ≠ seed extension

4. **Verify master key**:
   ```bash
   python verify_master_key.py
   ```
   Should show:
   - ✓ XPUB MATCHES
   - ✓ FINGERPRINT MATCHES

### Can't Find Address

1. The address might be at a higher index - increase search limit:
   ```bash
   python find_addresses_compressed.py --max-index 5000
   ```

2. Check if it's a change address (m/1/x) instead of receiving (m/0/x)

3. Verify the mnemonic is exactly correct (order and spelling)

## References

- Electrum documentation: https://electrum.readthedocs.io/
- Electrum source (seed validation): https://github.com/spesmilo/electrum/blob/master/electrum/mnemonic.py
- Electrum source (BIP32): https://github.com/spesmilo/electrum/blob/master/electrum/bip32.py
- BIP32 specification: https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki
- BIP39 specification: https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki
